<%= form.inputs :name => "Bonus Thresholds", :id => 'bonus-thresholds' do %>
  <%# The formtastic docs claim that you can use an 
  accept_nested_attributes_for along with certain options on form.inputs
  to do this nicely. As usual, the formtastic docs are full of shit. %>
  <% demo.bonus_thresholds.each_with_index do |bonus_threshold, bonus_threshold_index| %>
    <%= label_tag "demo_bonus_thresholds_#{bonus_threshold_index}_min_points", "Min points" %>
    <%= text_field_tag "demo[bonus_thresholds][#{bonus_threshold_index}][min_points]" %>
    <%= label_tag "demo_bonus_thresholds_#{bonus_threshold_index}_max_points", "Max points" %>
    <%= text_field_tag "demo[bonus_thresholds][#{bonus_threshold_index}][max_points]" %>
    <%= label_tag "demo_bonus_thresholds_#{bonus_threshold_index}_award", "Award" %>
    <%= text_field_tag "demo[bonus_thresholds][#{bonus_threshold_index}][award]" %>
    <br/>
  <% end %>

  <%= link_to 'Add another', '#', :id => 'add-bonus-threshold-row' %>
<% end %>

<%= form.inputs :name => "Levels", :id => 'levels' do %>
  <% demo.levels.each_with_index do |level, level_index| %>
    <%= label_tag "demo_levels_#{level_index}_threshold", "Threshold" %>
    <%= text_field_tag "demo[levels][#{level_index}][threshold]" %>
    <%= label_tag "demo_levels_#{level_index}_name", "Name" %>
    <%= text_field_tag "demo[levels][#{level_index}][name]", nil, :maxlength => 140 %>
    <%= add_byte_counter_for('Name') %>
    <br/>
  <% end %>

  <%= link_to 'Add another', '#', :id => 'add-level-row' %>
<% end %>

<% content_for :javascript do %>
  <%= javascript_tag do %>
    var nextBonusThresholdIndex = <%= demo.bonus_thresholds.length %>;
    var nextLevelIndex = <%= demo.levels.length %>;

    function humanize(fieldName) {
      var unUnderscored = fieldName.replace('_', ' ');
      return unUnderscored[0].toUpperCase() + unUnderscored.substr(1);
    }

    function addInputRow(fieldObjectPrefix, index, fieldNames, addingAnchor) {
      fieldIdPrefix = ['demo', '_', fieldObjectPrefix, '_', index, '_'].join('')
      fieldNamePrefix = ['demo[', fieldObjectPrefix, '][', index, ']['].join('');

      newHTML = $.map(fieldNames, function(fieldName) {
        return [

          '<label for="', fieldIdPrefix, fieldName, '">', humanize(fieldName), '</label>',
          '<input type="text" id="', fieldIdPrefix, fieldName, '" name="', fieldNamePrefix, fieldName, ']">'
        ].join('')
      }).join('') + "<br/>";

      addingAnchor.before(newHTML);
    };

    function addBonusThresholdRow(addingAnchor) {
      addInputRow(
        'bonus_thresholds', 
        nextBonusThresholdIndex, 
        ['min_points', 'max_points', 'award'], 
        addingAnchor
      );

      nextBonusThresholdIndex++;  
    };

    function addLevelRow(addingAnchor) {
      addInputRow(
        'levels',
        nextLevelIndex,
        ['threshold', 'name'],
        addingAnchor
      );

      nameFieldId = '#demo_levels_' + nextLevelIndex + '_name';
      $(nameFieldId).attr('maxlength', 140);
      addByteCounterFor(nameFieldId);

      nextLevelIndex++;
    };

    $('#add-bonus-threshold-row').click(function(e) {
      e.preventDefault();
      addBonusThresholdRow($(this));
    });

    $('#add-level-row').click(function(e) {
      e.preventDefault();
      addLevelRow($(this));
    });
  <% end %>
<% end %>
