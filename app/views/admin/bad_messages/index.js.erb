lastUpdatedAt = '<%= @last_updated_at %>';

updatedThreads = {
  <% @threads.reverse.each do |thr| %>
    <%= dom_id(thr) %>: '<%= escape_javascript(render :partial => 'thread', :object => thr) %>',
  <% end %>
}

var windowScroll;

windowScroll = $(document).scrollTop();

$.each(updatedThreads, function(div_id, new_html) {
  var dom_id = '#' + div_id;

  windowScroll -= $(dom_id).innerHeight();
  $(dom_id).remove();
  $('#threads').prepend(new_html);
  $(dom_id).hide().fadeIn('fast');
  windowScroll += $(dom_id).innerHeight();
});

$(document).scrollTop(windowScroll);

<%# The gsub here is a hack to remove starting & ending <script> tags from
    the JS content, which we do need. %>

<%= (yield :javascript).gsub(/<\/?script.*?>/, '') %>
