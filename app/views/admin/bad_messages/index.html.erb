<h2 class="first"><%= link_to "Admin", admin_path %>: Bad Message Log <span id="loading-message"> </span> </h2>

<div id="threads">
  <%= render :partial => 'thread', :collection => @threads %>
</div>

<div id="reply-dialog" style="display: none">
  <%= form_tag '#' do %>
    <%= label_tag 'bad_message_reply[body]', 'Say to user:' %>
    <%= text_area_tag 'bad_message_reply[body]' %>
    <%= submit_tag 'Send' %>
  <% end %>
</div>

<% content_for :javascript do %>
  <%= javascript_tag do %>
    var lastUpdatedAt = '<%= @last_updated_at %>';

    function loadingMessage(message) {
      $('#loading-message').html(message);
    }

    function refreshThreads() {
      $.ajax({
        url: '<%= admin_bad_messages_path(:format => :js) %>',
        data: {since: lastUpdatedAt},
        beforeSend: function() { loadingMessage('Checking for new messages...');},
        success: function() {loadingMessage('');},
        error: function() {loadingMessage('Error contacting server!')},
        complete: function() {setTimeout(refreshThreads, 3000)}
      });
    };

    refreshThreads();
  <% end %>
<% end %>
