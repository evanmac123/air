<h2 class="first"><%= link_to "Admin", admin_path %>: Bad Message Log <span id="loading-message"> </span> </h2>

<div id="new-messages">
  <h2>New Bad Messages</h2>
  <span class='message-count'><%= pluralize @new_messages.count, 'new bad message' %></span>
  <div class="messages">
    <%= render :partial => 'new_message', :collection => @new_messages, :as => :message %>
  </div>
</div>

<div id="watch-listed-messages">
  <h2>People we're helping or keeping an eye on</h2>
  <span class='message-count'><%= pluralize @needing_reply_count, 'new message' %> to reply to</span>
  <div class="messages">
    <%= render :partial => 'watch_listed_message', :collection => @watch_listed_messages, :as => :message %>
  </div>
</div>

<div id="all-messages">
  <h2>All Messages</h2>
  <span class="message-count"><%= pluralize @all_messages.count, "message" %> total</span>
  <div class="messages">
    <%= render :partial => 'generic_message', :collection => @all_messages, :as => :message %>
  </div>
</div>

<div id="reply-dialog" style="display: none">
  <%= form_tag '#' do %>
    <%= label_tag 'bad_message_reply[body]', 'Say to user:' %>
    <%= text_area_tag 'bad_message_reply[body]' %>
    <%= submit_tag 'Send' %>
  <% end %>
</div>

<% content_for :javascript do %>
  <%= javascript_tag do %>
    var newestMessageId = <%= @newest_message_id %>;

    $('#reply-dialog form').submit(function(e) {
      $.post(
        $(this).attr('action'), 
        $(this).serialize()
      );

      $('#reply-dialog').dialog('close');
      e.preventDefault();
    });

    $('.hideable-parts').hide();

    function uncollapse(message) {
      message.
        find('.hideable-parts').show().end().
        find('.collapse-control').data('collapsed', false).html('[-]');
    }

    function collapse(message) {
      message.
        find('.hideable-parts').hide().end().
        find('.collapse-control').data('collapsed', true).html('[+]');
    }

    function toggleMessageVisibility(selector) {
      var message = $(selector);
      var collapseControl = $(selector).find('.collapse-control');

      if(collapseControl.data('collapsed')) {
        uncollapse(message);
      } else {
        collapse(message);
      }
    }

    function updateMessageCount(selector, pluralizeText, remainingText, messageClass) {
      messageClass = messageClass || '.message';

      var messageCount = selector.find(messageClass).length;
      var updatedText = [
        '',
        messageCount,
        ' ',
        pluralizeText,
        (messageCount != 1 ? 's' : ''),
        ' ',
        remainingText
      ].join('');

      $(selector).find('.message-count').html(updatedText);
    };


    function updateNewMessageCount() {
      updateMessageCount($('#new-messages'), 'new bad message');
    }

    function updateWatchlistedMessageCount() {
      updateMessageCount($('#watch-listed-messages'), 'new message', 'to reply to', '.new-watchlisted-message');
    }

    function updateAllMessageCount() {
      updateMessageCount($('#all-messages'), 'message', 'total');
    }

    function pollForNewMessages() {
      $.get('/admin/bad_messages.js',
            {newest_message_id: newestMessageId});
    }

    function scheduleMessagePoll() {
      setTimeout(pollForNewMessages, 3000);
    }

    scheduleMessagePoll();
  <% end %>
<% end %>
