<% if use_intercom? %>
  <% http_host = controller.env['HTTP_HOST'] %>
  <% _intercom_user = @intercom_user || current_user || @user %>
  <% intercom_user_id_with_env = _intercom_user.id.to_s + "-" + Rails.env %>
  <% if _intercom_user.is_guest? %>
    <% intercom_user_id_with_env = "GUEST-" + intercom_user_id_with_env %>
  <% end %>

  <% js_at_end do %>
    bindIntercomSettings(
      "<%= _intercom_user.email.html_safe %>",
      <%= _intercom_user.accepted_invitation_at.to_i %>,
      "<%= _intercom_user.name %>",
      "<%= intercom_user_id_with_env %>",
      "<%= Digest::SHA1.hexdigest('9rlx8hyy' + intercom_user_id_with_env) %>", 
      "<%= _intercom_user.demo_id %>"
    );

    <%# We don't push regular user data to Intercom until they actually open
      the Intercom window, but we do for client admins on page load, so that
      it then proceeds on from Intercom to Salesforce. What, us convoluted? %>
    <% if _intercom_user.is_client_admin %>
      Intercom('boot', window._intercomSettings);
    <% end %>
  <% end %>
<% end %>
