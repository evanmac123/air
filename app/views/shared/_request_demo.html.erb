<section id="request_demo" class="lightbox-content">
  <h1>Great!</h1>
  <h2>We just need some info to get started.</h2>
  <form>
    <ul id="demo_basics">
      <li><input type="text" id="contact_name" placeholder="First and last name" /></li>
      <li><input type="text" id="contact_email" placeholder="Email address" /></li>
      <li><input type="text" id="contact_company" placeholder="Company" /></li>
      <li><input type="text" id="contact_role" placeholder="Role" /></li>
      <li><textarea id="contact_comment" placeholder="Tell us about your interests and priorities"></textarea></li>
    </ul>
    <input type="submit" value="All set!" />
    <span class="submitting_status" style="display:none">Submitting...</span>
  </form>
</section>

<script>
  $('.request_a_demo').click(function(){
    $("#request_demo").lightbox_me();
  });


  var contact_name = $('#contact_name');
  var contact_email = $('#contact_email');
  var contact_company = $('#contact_company');
  var contact_role = $('#contact_role');
  var contact_comment = $('#contact_comment');
  var contact_errors = 0;
  var submitting_status = $('.submitting_status');
  var request_demo = $('#request_demo');
  var contact_form = request_demo.find('form');

  var required_fields = [contact_name, contact_email, contact_company, contact_role, contact_comment];

  restartForm();

  function bindValidationToBlur(field) {
    field.blur(function() {validateField(field)});
  }

  _.each(required_fields, bindValidationToBlur);

  function validateInfoRequestForm(){
    _.each(required_fields, validateField);
  }

  function blankField(field) {
    return($.trim(field.val()) == '');
  }

  function validateField(field) {
    var _field = $(field);

    if(blankField(_field)) {
      _field.css('border','1px red solid');
      contact_errors = true;
    } else {
      _field.css('border','1px #4FAA60 solid');
    }
  }

  function disableInputFields(form) {
    form.find('input, textarea').attr('disabled', 'disabled');
  }
  
  function restartForm(){
    contact_form.find('input, textarea').removeAttr('disabled');
    contact_form.find('input[type=text], textarea').val('')
  }

  function fadeOutThanksMessage() {
    request_demo.animate({opacity: 0}, {complete: function() {request_demo.trigger('close');}});
  }

  function doAfterInfoRequest() {
    submitting_status.hide();
    disableInputFields(contact_form);
    request_demo.text("Thanks! We'll be in touch.");
    window.setTimeout(fadeOutThanksMessage, 3000);
  }

  function submitInfoRequest(form) {
    submitting_status.show();
    var data = {
      // .serialize should work but doesn't.
      contact_name:    contact_name.val(),
      contact_email:   contact_email.val(),
      contact_company: contact_company.val(),
      contact_role:    contact_role.val(),
      contact_comment: contact_comment.val()
    };
    $.post('email_info_requests', data, function(message){
      doAfterInfoRequest();
    });

  }

  $('#request_demo form input[type=submit]').click(function(e){
    e.preventDefault();
    contact_errors = false;
    validateInfoRequestForm();
    if (!contact_errors){
      submitInfoRequest(contact_form);
    }
  });


</script>
