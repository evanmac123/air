<%= yield :javascript %>
<% if Rails.env.test? %>
  <%= javascript_tag do %>
    $.ajaxSetup({ async: false });
  <% end %>
<% end %>

<!-- Off-canvas nav using jRespond -->
<script>

// ====== TOP BAR DESKTOP MENU CONTROLS (plz abstract me) ======
var user_toggler = $('#me_toggle'), 
    admin_toggler = $('#admin_toggle'),
    desktop_user_menu = $('.user_options ul'),
    desktop_admin_menu = $('.client_admin_pages');

function hideUserMenu() {
  user_toggler.find('.shadow_overlay').hide();
  user_toggler.removeClass('toggled');
  desktop_user_menu.slideUp('fast');
}
function hideAdminMenu() {
  admin_toggler.removeClass('toggled');
  desktop_admin_menu.slideUp('fast');
}

function showUserMenu() {
  user_toggler.find('.shadow_overlay').show();
  user_toggler.addClass('toggled');
  desktop_user_menu.slideDown('fast');
}
function showAdminMenu() {
  admin_toggler.addClass('toggled');
  desktop_admin_menu.slideDown('fast');
}

function optionsToggle() {
  admin_toggler.mouseenter(function() {
    if(admin_toggler.is(':hover') || desktop_admin_menu.is(':hidden')) {
      showAdminMenu();
    }
  }).mouseleave(function(){
    if(desktop_admin_menu.is(':visible')) {
      return false;
    } else {
      hideAdminMenu();
    }
  });


  $('.user_options ul, .client_admin_pages').mouseleave(function() {
    hideUserMenu();
    hideAdminMenu();
  });
  $('.user_options ul, .client_admin_pages').find('a').click(function() {
    hideUserMenu();
    hideAdminMenu();
  });
}


// ========= jRespond and jPanelMenu ==========
var jPM = $.jPanelMenu({
  menu: 'header nav',
  trigger: '.off-canvas-toggle a'
});
var jRes = jRespond([
  {
    label: 'small',
    enter: 0,
    exit: 767
  },{
    label: 'large',
    enter: 768,
    exit: 10000
  }
]);

jRes.addFunc([
  {
    breakpoint: 'small',
    enter: function() {
      window.intercomDisabled = true;
      jPM.on();
      desktop_user_menu.show();
      desktop_admin_menu.show();
    },
    exit: function() {
      jPM.off();
      hideUserMenu();
      hideAdminMenu();
    }
  },{
    breakpoint: 'large',
    enter: function() {
      user_toggler.on();
      admin_toggler.on();
      optionsToggle();
    },
    exit: function() {
      user_toggler.off();
      admin_toggler.off();
      desktop_user_menu.show();
      desktop_admin_menu.show();
    }
  }
]);
</script>
