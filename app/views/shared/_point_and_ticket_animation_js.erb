var animateCounter = function(domID, previous, current, duration, callback) {
  var counter = new countUp(domID, previous, current, 0, duration);
  counter.useEasing = false;

  var element = $('#' + domID);
  element.addClass('counting');
  counter.start(function() {
    element.removeClass('counting');
    if(typeof(callback) === 'function') {
      callback();
    }
  });
};

var progressBar = $('#completed_progress');

var fillBarToFinalPercentage = function(finalPercentage, allTilesDone, callback) {
  progressBar.addClass('counting');
  progressBar.animate({width: finalPercentage}, 750, 'linear', function() {
    progressBar.removeClass('counting');
    if(typeof(callback) === 'function') {
      callback();
    } 

    if(!allTilesDone) {
      loadFollowingTile()
    }
  });
};

var loadFollowingTile = function() {
  loadNextTileWithOffset(1);
}

var fillBarEntirely = function(previousTickets, currentTickets, finalPercentage, allTilesDone) {
  var emptyBarCallback = function() {
    progressBar.css('width', '0%');
    fillBarToFinalPercentage(finalPercentage, allTilesDone, function() {
      animateCounter('user_tickets', previousTickets, currentTickets, 0.1)
    });
  }

  progressBar.addClass('counting');
  progressBar.animate({width: '100%'}, 750, 'linear', emptyBarCallback);
};

var fillBar = function(previousTickets, currentTickets, finalPercentage, allTilesDone) {
  var ticketsIncreased = (previousTickets < currentTickets);
  if(ticketsIncreased) {
    fillBarEntirely(previousTickets, currentTickets, finalPercentage, allTilesDone);
  } else {
    fillBarToFinalPercentage(finalPercentage, allTilesDone); 
  }
}
