<div class="tile_texts_container">
  <div class="tile_quiz">
    <%= form.hidden_field :question_type %>
    <%= form.hidden_field :question_subtype %>
    <div class="tile_types">
      <ul class="button-group">
        <% tile_types.each do |type, subtypes| %>
          <li class="tile_type">
            <a id="<%= type %>" href="#" data-dropdown="drop_<%= type %>" class="button type"><%= type %> <i class="fa fa-caret-down"></i></a>

            <ul id="drop_<%= type %>" class="f-dropdown">
              <% subtypes.each do |key, subtype| %>
                <li id="<%= type + '-' + key %>" class="subtype" ><%= subtype[:name] %></li>
              <% end %>
            </ul>
          </li>
        <% end %>
      </ul>      
    </div>
    <div class="quiz_content">
      <p class="placeholder">Pick what users will earn points for.</p>
    </div>
    <div id="set_points" class="content_sections">
      <p>How many points is this tile worth (1 to 20)?</p>
      <%= form.text_field :points, {maxlength: 2} %>
      <%= form.label :points %>
    </div>
  </div>
</div>
<% content_for :javascript do %>
  <%= javascript_tag do %>
    window.tile_types = <%= raw(tile_types.to_json) %>;

    $(function() {
      <% if params[:action] == "edit" || params[:action] == "update" || (params[:action] == "create" && @tile_builder_form.question_type) %>
        window.tile_types = <%= raw(update_tile_types(tile_types, @tile_builder_form).to_json) %>;

        type = "<%= raw @tile_builder_form.question_type %>"
        subtype = "<%= raw @tile_builder_form.question_subtype %>"
        $("#" + type + "-" + subtype).click().click();
      <% else %>
        window.tile_types = <%= raw(tile_types.to_json) %>;
      <% end %>
    });

    function turnRadioGreen() {
      $('.option_radio').unbind();
      $('.option_radio').click(function() {
        var radioButton = $(this).find('input:radio');
        if($(this).hasClass('option_selected')){
          $('.option_radio').removeClass('option_selected');  
          radioButton.prop('checked', false);
        }else {
          $('.option_radio').removeClass('option_selected');  
          radioButton.attr('checked','true');
          $(this).addClass('option_selected');
        } 
        markRightAnswer(this);
      });
    };

    addCharacterCounterFor('#tile_builder_form_headline');
    addCharacterCounterFor('#tile_builder_form_supporting_content');
    _.each($('.answer-field'), addCharacterCounterFor);
    turnRadioGreen();

    $(".subtype").click(function selectSubtype(){
      type = getTileType($(this).attr("id"));
      subtype = getTileSubtype($(this).attr("id"));

      makeButtonsSelected(type, $(this).attr("id"));
      showQuestionAndAnswers(tile_types[type][subtype]);
      showSelectAndAddAnswer();
      saveTypeToForm();

      _.each($('.answer-field'), addCharacterCounterFor);
      turnRadioGreen();
      selectMessage();
      rebindEvents();
    });

    $(".type").click(function closeOtherDropdowns() {
      list_id = $(this).attr("data-dropdown");
      $(".f-dropdown").each(function() {
        if(list_id != $(this).attr("id")){
          $(this).removeClass("open").removeAttr("style");
        }
      });
    });

    function rebindEvents() {
      $("#tile_builder_form_question").bind('input propertychange', function() {
        saveQuestionChanges(this);
      });

      $(".answer-field.answer-part").bind('input propertychange', function() {
        saveAnswerChanges(this);
      });

      $('body').unbind();
      $('body').click(function(event) {
        if (!$(event.target).is(".tile_question") && !$(event.target).is("#tile_builder_form_question")) {
          turnOffEditQuestion();
        };
        tryTurnOffEditAnswer(event.target);
      });

      $(".tile_question").click(function() {
        turnOnEditQuestion(this);
      });

      $(".tile_multiple_choice_answer a").click(function() {
        turnOnEditAnswer(this);
      });

      var initialAnswerField = $('.answer_option').eq(0);

      $('.add_answer').click(function(e) {
        addNewAnswer();
      });

      $('.answer-field').keydown(function openNextAnswerOnTab(e) {
        code = e.keyCode || e.which;
        next_answer = $(this).closest(".tile_multiple_choice_answer").next(".tile_multiple_choice_answer");
        if (code == '9') {
          if(next_answer.length > 0){
            next_answer.find("a").click();
            return false;
          }else{
            turnOffEditAnswer($(this).closest(".tile_multiple_choice_answer"));
          }
        }
      });

      $('#tile_builder_form_question').keydown(function openFirstAnswerOnTab(e) {
        code = e.keyCode || e.which;
        if (code == '9') {
          $(".multiple_choice_group").find(".tile_multiple_choice_answer").first().find("a:first").click();
          return false;
        }
      });
    };
  <% end %>
<% end %>
